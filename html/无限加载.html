<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="https://cdn.bootcss.com/jquery/3.2.0/jquery.js"></script>
  <script src="./tempalte.js"></script>
  <title>Document</title>
  <style>
    .slide .img {
      display: inline-block;
      width: 90px;
      height: 90px;
      margin: 0 auto;
      opacity: 0;
      -webkit-transition: opacity 0.25s ease-in-out;
      -moz-transition: opacity 0.25s ease-in-out;
      -o-transition: opacity 0.25s ease-in-out;
      transition: opacity 0.25s ease-in-out;
    }
  </style>
</head>

<body>
  <div class="exp-list-box" id="expListBox">
    <ul class="exp-list" id="expList">
    </ul>
    <div class="ui-refresh-down"></div>
  </div>
</body>

</html>
<script>

</script>
<script id="tpl" type="text/html">
  <!-- <ul>
    <%for(var i = 0; i < dataList.length; i++) {%>
    <li><%:=dataList[i].name%></li>
    <%}%>
  </ul> -->
  

   <% dataList.forEach(function (v) { %>
        <!-- <div > -->
            <li id="s-<%:=Math.round(Math.random()*(10000))%>" class="slide">
                <a href="<%=v.href%>">
                    <img class="img" src='data:img/jpg;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEXs7Oxc9QatAAAACklEQVQI12NgAAAAAgAB4iG8MwAAAABJRU5ErkJggg==' 
                    data-src="<%=v.src%>">
                    </img>
                    <strong><%:=v.title %></strong>
                    <span class="writer"><%:=v.writer %></span>
                    <span class="good-num"><%:=v.succNum %></span>
                </a>
            </li>
        <!-- </div> -->
    <% }) %>
</script>
<script>

  (function () {
    var fetching = false;
    var page = 1;
    var slideCache = [];
    var itemMap = {};
    var lastScrollY = window.pageYOffset;
    var scrollY = window.pageYOffset;
    var innerHeight;
    var topViewPort;
    var bottomViewPort;

    // ...判断元素是否在可见区域
    function isVisible(id) {
      var offTop;
      var offsetHeight;
      var data;
      var node;

      // 判断此元素是否已经懒加载正确渲染，分为在屏幕之上（已经懒加载完毕）和屏幕外，已经添加到dom中，但是还未请求图片（懒加载之前）
      if (itemMap[id]) {
        // 直接获取offTop，offsetHeight值
        offTop = itemMap[id].offTop;
        offsetHeight = itemMap[id].offsetHeight;
      } else {
        // 设置该节点，并且设置节点属性：node，offTop，offsetHeight
        node = document.getElementById(id);
        // offsetHeight是自身元素的高度
        offsetHeight = parseInt(node.offsetHeight);
        // 元素的上外缘距离最近采用定位父元素内壁的距离
        offTop = parseInt(node.offsetTop);
      }
      // offTop + offsetHeight 
      // window.scrollY - 1000
      // window.scrollY + innerHeight + 600
      if (offTop + offsetHeight > topViewPort && offTop < bottomViewPort) {
        return true;
      }
      else {
        console.log('--------------');
        return false;
      }
    }

    // ....更新DOM缓存

    function updateItemCache(node) {
      // debugger
      var list = node.querySelectorAll('.slide');
      var len = list.length;
      slideCache = [];
      var obj;

      for (var i = 0; i < len; i++) {
        obj = {
          node: list[i],
          id: list[i].getAttribute('id'),
          img: list[i].querySelector('.img')
        }
        obj.src = obj.img.getAttribute('data-src');
        slideCache.push(obj);
      };
    }

    // ...ajax请求数据
    function fetchContent() {
      // 设置加载状态锁
      if (fetching) {
        return;
      }
      else {
        fetching = true;
      }
      $.ajax({
        url: ' https://easy-mock.com/mock/59a8fd8e83eb501241b25220/example//must',
        // timeout: 300000,
        dataType: 'json',
        success: function (data) {
          if (data.errno) {
            return;
          }
          console.time('render');
          var dataList = data.data;
          // debugger
          var len = dataList.length;
          var ulContainer = document.getElementById('expList');
          var str = '';
          var frag = document.createElement('div');

          var tpl = window.template(document.getElementById('tpl').innerHTML);
          for (var i = 0; i < len; i++) {
            str = tpl({ dataList: dataList });
          }
          frag.innerHTML = str;
          ulContainer.appendChild(frag);
          // 更新缓存 新创建的那个接节点
          updateItemCache(frag);
          // 已经拉去完毕，设置标识为true
          fetching = false;
          // 强制触发
          handleScroll(null, true);
          page++;
          console.timeEnd('render');
        }
      })
      // .then(function (data) {
      //   debugger

      // }, function (xhr, type) {
      //   console.log('Refresh:Ajax Error!');
      // });
    }

    // ...懒加载实现
    function handleDefer() {
      // 时间记录
      console.time('defer');

      // 获取dom缓存
      var list = slideCache;
      // 对于遍历list里的每一项，都使用一个变量，而不是在循环内部声明。节省内存，把性能高效，做到极致。
      var thisImg;

      for (var i = 0, len = list.length; i < len; i++) {
        thisImg = list[i].img; // 这里我们都是从内存中读取，而不用读取DOM节点
        var deferSrc = list[i].src; // 这里我们都是从内存中读取，而不用读取DOM节点
        // 判断元素是否可见
        if (isVisible(list[i].id)) {
          // 这个函数是图片onload逻辑
          var handler = function () {
            var node = thisImg;
            var src = deferSrc;
            // 创建一个闭包
            return function () {
              node.src = src;
              node.style.opacity = 1;
            }
          }
          var img = new Image();
          img.onload = handler();
          img.src = list[i].src;
        }
      }
      console.timeEnd('defer');
    }

    function handleScroll(e, force) {
      // 如果时间间隔内，没有发生滚动，且并未强制触发加载，则do nothing，再次间隔100毫秒之后查询
      if (!force && lastScrollY === window.scrollY) {
        window.setTimeout(handleScroll, 100);
        return;
      } else {
        // 更新文档滚动位置
        lastScrollY = window.scrollY;
      }
      // debugger

      scrollY = window.scrollY;
      // 浏览器窗口的视口（viewport）高度赋值
      innerHeight = window.innerHeight;
      // 计算isVisible上下阈值
      topViewPort = scrollY - 1000;
      bottomViewPort = scrollY + innerHeight + 600;

      // 判断是否需要加载
      // document.body.offsetHeight;返回当前网页高度 
      // 大于200px 就开始请求
      if (window.scrollY + innerHeight + 200 > document.body.offsetHeight) {
        fetchContent();
      }
      // 实现懒加载
      handleDefer();
      window.setTimeout(handleScroll, 100);
    }

    window.setTimeout(handleScroll, 100);
    fetchContent();
  }());


</script>